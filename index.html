<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>MTA 7 Line Live</title>

    <!-- Pico CSS -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css"
    />

    <!-- htmx -->
    <script
      src="https://cdn.jsdelivr.net/npm/htmx.org@2.0.7/dist/htmx.min.js"
      integrity="sha384-ZBXiYtYQ6hJ2Y0ZNoYuI+Nq5MqWBr+chMrS/RkXpNzQCApHEhOt2aY8EJgqwHLkJ"
      crossorigin="anonymous"
      defer
    ></script>

    <style>
      /* Prefer Helvetica (MTA look) where available; fall back safely elsewhere */
      :root {
        --pico-font-family-sans-serif:
          "Helvetica Neue", Helvetica, Arial,
          "Nimbus Sans", "Liberation Sans",
          system-ui, "Segoe UI", Roboto, Ubuntu, Cantarell,
          "Noto Sans", sans-serif, var(--pico-font-family-emoji);
        --pico-font-family: var(--pico-font-family-sans-serif);
      }

      /* Clean, aligned numerals for times/ETAs */
      .eta, .time, .mono-numbers {
        font-variant-numeric: tabular-nums;
      }

      .bullet { width: 1em; height: 1em; vertical-align: -0.15em; margin: 0 .15em; }
      .bullet.diamond { transform: scale(1.18); }
      @media (max-width: 480px) {
        .bullet { width: .95em; height: .95em; vertical-align: -0.12em; }
      }

      /* Nearby panel tweaks */
      .nearby-list {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
      }
      .nearby-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0.6rem 0.8rem;
        border: var(--pico-border-width) solid var(--pico-muted-border-color);
        border-radius: 12px;
        background: var(--pico-card-background-color);
      }
      .nearby-title {
        display: flex;
        flex-direction: column;
        gap: 0.15rem;
      }
      .nearby-title strong {
        font-size: 0.95rem;
        line-height: 1.1;
      }
      .nearby-title small {
        color: var(--pico-muted-color);
      }
      .nearby-actions {
        display: grid;
        grid-template-columns: repeat(2, auto);
        gap: 0.5rem;
      }

      .btn-sm {
        font-size: 0.85rem;
        padding: 0.35rem 0.55rem;
        border-radius: 10px;
      }
      .twocol {
        display: grid;
        gap: 1rem;
      }
      @media (min-width: 900px) {
        .twocol {
          grid-template-columns: 1fr 2fr;
        }
      }
      @media (max-width: 600px) {
        #useLocBtn {
          width: 100%;
        }
      } /* nicer button on phones */

      @media (min-width: 900px) {
      aside {
        position: sticky;
        top: 0.75rem;
        align-self: start;
        max-height: calc(100vh - 2rem);
        overflow: auto;
      }
    }

      /* Table container scroll (not per-cell) */
      .table-wrap {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }
      @media (max-width: 480px) {
        h1 {
          font-size: 1.25rem;
        }
        h2 {
          font-size: 1.05rem;
        }
        table {
          font-size: 0.95rem;
        }
      }
      /* Subtle loading bar tied to hx-indicator */
      #loading[aria-busy="true"] {
        display: block !important;
      }

      /* Base cell padding/align */
      #arrivals thead th,
      #arrivals tbody td {
        padding: 0.55rem 0.7rem;
        vertical-align: middle;
      }

      /* Let "Where now" wrap naturally; keep ETA/Time on one line */
      #arrivals tbody td:nth-child(3) { white-space: normal; }
      #arrivals thead th:nth-child(4),
      #arrivals tbody td:nth-child(4),
      #arrivals thead th:nth-child(5),
      #arrivals tbody td:nth-child(5) { white-space: nowrap; }

      /* Sticky header for usability on mobile */
      #arrivals thead th {
        position: sticky;
        top: 0;
        background: var(--pico-card-background-color);
        z-index: 1;
      }

      /* Mobile tweaks */
      @media (max-width: 600px) {
        /* Hide Status column on narrow phones */
        #arrivals thead th:nth-child(6),
        #arrivals tbody td:nth-child(6) { display: none; }

        /* Optional: hide Trip column to gain space */
        #arrivals thead th:nth-child(2),
        #arrivals tbody td:nth-child(2) { display: none; }

        table { font-size: 0.95rem; }
        h1 { font-size: 1.25rem; }
        h2 { font-size: 1.05rem; }

        /* Nearby button full width */
        #useLocBtn { width: 100%; }
      }

      /* === Desktop tweaks (>=900px) === */
      @media (min-width: 900px) {
        h1 { font-size: 1.6rem; line-height: 1.25; }
        h2 { font-size: 1.25rem; }
        /* Slightly tighter table */
        #arrivals thead th,
        #arrivals tbody td { padding: 0.5rem 0.65rem; }
      }

      /* === Compact table mode === */
      .compact-table #arrivals thead th,
      .compact-table #arrivals tbody td {
        padding: 0.4rem 0.55rem;
        line-height: 1.2;
      }
      /* Keep ETA/Time on one line; allow 'Where now' to wrap */
      .compact-table #arrivals tbody td:nth-child(3) { white-space: normal; }
      .compact-table #arrivals tbody td:nth-child(4),
      .compact-table #arrivals tbody td:nth-child(5) { white-space: nowrap; }

      /* === Mobile defaults (<=600px): use compact automatically === */
      @media (max-width: 600px) {
        :root { --pico-font-size: 16px; }          /* slightly smaller base */
        body { font-size: var(--pico-font-size); } /* ensure it takes effect */
        h1 { font-size: 1.25rem; }
        h2 { font-size: 1.05rem; }
        /* Hide less-important columns on phones */
        #arrivals thead th:nth-child(2),
        #arrivals tbody td:nth-child(2), /* Trip */
        #arrivals thead th:nth-child(6),
        #arrivals tbody td:nth-child(6)  /* Status */
        { display: none; }
        /* Apply compact mode on mobile */
        body { /* acts like toggling compact-table */ }
        #arrivals thead th,
        #arrivals tbody td { padding: 0.4rem 0.5rem; line-height: 1.2; }
      }
    </style>
  </head>
  <body>
    <main class="container">
      <header>
      <h1>
        MTA 7/7X <span aria-hidden="true">
          <img class="bullet" src="/icons/7.svg" alt="" aria-hidden="true">
          <img class="bullet diamond" src="/icons/7d.svg" alt="" aria-hidden="true">
        </span> ‚Äî live arrivals
      </h1>
      </header>
      <p class="muted">Realtime arrivals for 7 / 7X (default: Vernon Blvd-Jackson Av)</p>
      <p id="liveClock" class="muted small"></p>

      <article class="twocol">
        <!-- LEFT: Nearby (filled by geolocation) -->
        <aside hx-target="#nearby">
          <header>
            <h3>Nearby stops</h3>
            <small>Find closest 7/7X stations from your location</small>
          </header>

          <p class="grid" style="align-items: center; gap: 0.5rem">
            <button id="useLocBtn" class="primary btn-sm" type="button">
              üìç Use my location
            </button>
            <small id="locLabel" class="muted">Loc: ‚Äî</small>
          </p>

          <div class="table-wrap">
            <div id="nearby"><em>Grant location to see nearby stops.</em></div>
          </div>
        </aside>

        <!-- RIGHT: Arrivals -->
        <section>
          <progress
            id="loading"
            class="secondary"
            style="display: none"
            aria-busy="false"
          ></progress>
          
          <form id="arrivalsParams" hidden>
            <input id="stopIdField" name="stopId" value="721S">
            <input id="horizonField" name="horizonMin" value="30">
          </form>

          <div class="table-wrap">
            <div
              id="arrivals"
              hx-get="/api/arrivals"
              hx-include="#arrivalsParams"
              hx-trigger="load, every 15s"
              hx-swap="innerHTML"
              hx-indicator="#loading"
              hx-on:htmx:before-request="document.querySelector('#loading').setAttribute('aria-busy','true')"
              hx-on:htmx:after-request="document.querySelector('#loading').setAttribute('aria-busy','false')"
              hx-on:htmx:after-swap="this.classList.add('refreshed'); setTimeout(()=>this.classList.remove('refreshed'), 300)"
            ></div>
          </div>
          
          <button
            class="contrast"
            hx-get="/api/arrivals"
            hx-include="#arrivalsParams"
            hx-target="#arrivals"
            hx-swap="innerHTML"
            hx-indicator="#loading"
          >
            Refresh
          </button>
        </section>
      </article>
    </main>

    <script type="module" src="/main.js"></script>
    <script>
      (function () {
        const el = document.getElementById("liveClock");
        if (!el) return;
        const fmt = new Intl.DateTimeFormat("en-US", {
          timeZone: "America/New_York",
          hour: "2-digit",
          minute: "2-digit",
          second: "2-digit",
        });
        function tick() {
          el.textContent = "NY time: " + fmt.format(new Date());
        }
        tick();
        setInterval(tick, 1000);
      })();
    </script>
    <script>
      /**
       * Hard guard: any htmx request fired from inside the Nearby <aside>
       * will swap into #nearby (never #arrivals), unless the triggering element
       * explicitly marks itself as "to-arrivals".
       *
       * Usage for opt-out (when you *do* want to update the arrivals table from a Nearby item):
       *   <a class="to-arrivals" hx-get="/api/arrivals?stopId=721S" hx-target="#arrivals">‚Ä¶</a>
       */
      (function () {
        document.body.addEventListener("htmx:beforeSwap", function (e) {
          const origin = e.detail.elt;
          if (!origin) return;

          const inNearby = origin.closest("aside"); // our Nearby panel
          const explicitToArrivals =
            origin.classList && origin.classList.contains("to-arrivals");

          // If the request originates inside Nearby and is NOT explicitly targeting arrivals,
          // force the swap target to #nearby.
          if (inNearby && !explicitToArrivals) {
            const nearbyTarget = document.getElementById("nearby");
            if (nearbyTarget) e.detail.target = nearbyTarget;
          }
        });
      })();
    </script>
  </body>
</html>
